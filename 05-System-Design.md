# System Design - ĞÑ‚Ğ²ĞµÑ‚Ñ‹ Ğ½Ğ° Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²ÑŒÑ

## ğŸ“š Ğ¢ĞµĞ¾Ñ€Ğ¸Ñ

### 1. CAP Theorem

**Ğ’Ğ¾Ğ¿Ñ€Ğ¾Ñ:** ĞĞ±ÑŠÑÑĞ½Ğ¸Ñ‚Ğµ Ñ‚ĞµĞ¾Ñ€ĞµĞ¼Ñƒ CAP. ĞšĞ°Ğº Ğ¾Ğ½Ğ° Ğ²Ğ»Ğ¸ÑĞµÑ‚ Ğ½Ğ° Ğ²Ñ‹Ğ±Ğ¾Ñ€ Ğ¼ĞµĞ¶Ğ´Ñƒ PostgreSQL Ğ¸ Cassandra?

**ĞÑ‚Ğ²ĞµÑ‚:**

**CAP Ñ‚ĞµĞ¾Ñ€ĞµĞ¼Ğ°** ÑƒÑ‚Ğ²ĞµÑ€Ğ¶Ğ´Ğ°ĞµÑ‚, Ñ‡Ñ‚Ğ¾ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ½Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ 2 Ğ¸Ğ· 3 ÑĞ²Ğ¾Ğ¹ÑÑ‚Ğ²:

```
                 Consistency
                     /\
                    /  \
                   /    \
                  /  CP  \
                 /________\
                /    CA    \
               /____________\
              /      AP      \
       Availability â”€â”€â”€â”€â”€â”€â”€â”€ Partition Tolerance
```

**Ğ¡Ğ²Ğ¾Ğ¹ÑÑ‚Ğ²Ğ°:**
- **Consistency (C):** Ğ²ÑĞµ ÑƒĞ·Ğ»Ñ‹ Ğ²Ğ¸Ğ´ÑÑ‚ Ğ¾Ğ´Ğ¸Ğ½Ğ°ĞºĞ¾Ğ²Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾
- **Availability (A):** ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚ (ÑƒÑĞ¿ĞµÑ… Ğ¸Ğ»Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°)
- **Partition Tolerance (P):** ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¸ ÑĞµÑ‚ĞµĞ²Ñ‹Ñ… Ñ€Ğ°Ğ·Ñ€Ñ‹Ğ²Ğ°Ñ… Ğ¼ĞµĞ¶Ğ´Ñƒ ÑƒĞ·Ğ»Ğ°Ğ¼Ğ¸

**ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ 2 Ğ¸Ğ· 3:**
ĞŸÑ€Ğ¸ ÑĞµÑ‚ĞµĞ²Ğ¾Ğ¼ Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğ¸ (P) ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ:
- **Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ğ¾Ñ‚Ğ²ĞµÑ‚** (A) â†’ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑƒÑÑ‚Ğ°Ñ€ĞµĞ²ÑˆĞ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ (Ğ½ĞµÑ‚ C)
- **Ğ–Ğ´Ğ°Ñ‚ÑŒ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸** (C) â†’ Ğ½ĞµÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° (Ğ½ĞµÑ‚ A)

**ĞšĞ»Ğ°ÑÑĞ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ ÑĞ¸ÑÑ‚ĞµĞ¼:**

| Ğ¢Ğ¸Ğ¿ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ | ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹ |
|-----|----------|---------|
| CP | ĞšĞ¾Ğ½ÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ + Partition Tolerance | MongoDB (Ğ² Ğ½ĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ñ… Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ°Ñ…), HBase, Redis Cluster |
| AP | Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ + Partition Tolerance | Cassandra, DynamoDB, CouchDB |
| CA | ĞšĞ¾Ğ½ÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ + Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ | Ğ¢Ñ€Ğ°Ğ´Ğ¸Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğµ RDBMS (PostgreSQL, MySQL) â€” single node |

**PostgreSQL vs Cassandra:**

| ĞÑĞ¿ĞµĞºÑ‚ | PostgreSQL | Cassandra |
|--------|------------|-----------|
| CAP | CA (single) / CP (cluster) | AP |
| ĞœĞ¾Ğ´ĞµĞ»ÑŒ | Ğ ĞµĞ»ÑÑ†Ğ¸Ğ¾Ğ½Ğ½Ğ°Ñ, ACID | Wide-column, eventual consistency |
| ĞœĞ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ | Ğ’ĞµÑ€Ñ‚Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ + read replicas | Ğ“Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ |
| Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ | ĞĞ´Ğ¸Ğ½ master | Ğ›ÑĞ±Ğ¾Ğ¹ ÑƒĞ·ĞµĞ» |
| ĞšĞ¾Ğ½ÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ | Strong | Tunable (ONE, QUORUM, ALL) |
| Use case | Ğ¢Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸, ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ | Ğ’Ñ‹ÑĞ¾ĞºĞ°Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ, time-series |

**ĞšĞ¾Ğ³Ğ´Ğ° PostgreSQL:**
- ACID Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹
- Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ñ‹Ğµ JOIN, Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°
- Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°

**ĞšĞ¾Ğ³Ğ´Ğ° Cassandra:**
- ĞĞ³Ñ€Ğ¾Ğ¼Ğ½Ñ‹Ğµ Ğ¾Ğ±ÑŠĞµĞ¼Ñ‹ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸
- Ğ“ĞµĞ¾Ğ³Ñ€Ğ°Ñ„Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ
- ĞĞµÑ‚ ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ñ… ÑĞ²ÑĞ·ĞµĞ¹ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸
- Ğ”Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ğ¼Ğ° eventual consistency

---

### 2. Microservices vs Monolith

**Ğ’Ğ¾Ğ¿Ñ€Ğ¾Ñ:** ĞšĞ¾Ğ³Ğ´Ğ° Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ñ‚ÑŒ Ğº Ğ¼Ğ¸ĞºÑ€Ğ¾ÑĞµÑ€Ğ²Ğ¸ÑĞ°Ğ¼? ĞĞ°Ğ·Ğ¾Ğ²Ğ¸Ñ‚Ğµ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ Ğ¸ ÑĞ¿Ğ¾ÑĞ¾Ğ±Ñ‹ Ğ¸Ñ… Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ.

**ĞÑ‚Ğ²ĞµÑ‚:**

**ĞœĞ¾Ğ½Ğ¾Ğ»Ğ¸Ñ‚:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Monolith App             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚Usersâ”‚ â”‚Ordersâ”‚ â”‚Paym.â”‚ â”‚Notifâ”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           Shared Database           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ĞœĞ¸ĞºÑ€Ğ¾ÑĞµÑ€Ğ²Ğ¸ÑÑ‹:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Users   â”‚  â”‚  Orders  â”‚  â”‚ Payments â”‚  â”‚  Notif   â”‚
â”‚  Service â”‚  â”‚  Service â”‚  â”‚  Service â”‚  â”‚  Service â”‚
â”‚   [DB]   â”‚  â”‚   [DB]   â”‚  â”‚   [DB]   â”‚  â”‚   [DB]   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚             â”‚             â”‚             â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   Message Bus / API Gateway
```

**ĞšĞ¾Ğ³Ğ´Ğ° Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ñ‚ÑŒ Ğº Ğ¼Ğ¸ĞºÑ€Ğ¾ÑĞµÑ€Ğ²Ğ¸ÑĞ°Ğ¼:**
- ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° > 50 Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¾Ğ² (Ğ·Ğ°ĞºĞ¾Ğ½ ĞšĞ¾Ğ½Ğ²ĞµÑ)
- Ğ Ğ°Ğ·Ğ½Ñ‹Ğµ Ñ‡Ğ°ÑÑ‚Ğ¸ Ñ‚Ñ€ĞµĞ±ÑƒÑÑ‚ Ñ€Ğ°Ğ·Ğ½Ğ¾Ğ³Ğ¾ Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
- Ğ Ğ°Ğ·Ğ½Ñ‹Ğµ Ñ‚ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ğ¸ Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡
- ĞĞµĞ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ñ‹Ğµ Ñ€ĞµĞ»Ğ¸Ğ·Ñ‹ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹
- ĞœĞ¾Ğ½Ğ¾Ğ»Ğ¸Ñ‚ ÑÑ‚Ğ°Ğ» "Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ğ¼ ĞºĞ¾Ğ¼Ğ¾Ğ¼ Ğ³Ñ€ÑĞ·Ğ¸"

**ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ Ğ¸ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ:**

**1. Distributed Transactions:**
```
ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°: ĞÑ‚Ğ¾Ğ¼Ğ°Ñ€Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¼ĞµĞ¶Ğ´Ñƒ ÑĞµÑ€Ğ²Ğ¸ÑĞ°Ğ¼Ğ¸
Ğ ĞµÑˆĞµĞ½Ğ¸Ñ:
â€¢ SAGA Pattern â€” Ñ†ĞµĞ¿Ğ¾Ñ‡ĞºĞ° Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ñ… Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹ + ĞºĞ¾Ğ¼Ğ¿ĞµĞ½ÑĞ°Ñ†Ğ¸Ğ¸
â€¢ Eventual Consistency â€” Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚ÑŒ Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºÑƒ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
â€¢ Event Sourcing â€” ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ĞºĞ°Ğº Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ¸ÑÑ‚Ğ¸Ğ½Ñ‹
```

**2. Service Discovery:**
```
ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°: ĞšĞ°Ğº ÑĞµÑ€Ğ²Ğ¸ÑÑ‹ Ğ½Ğ°Ñ…Ğ¾Ğ´ÑÑ‚ Ğ´Ñ€ÑƒĞ³ Ğ´Ñ€ÑƒĞ³Ğ°?
Ğ ĞµÑˆĞµĞ½Ğ¸Ñ:
â€¢ DNS-based (Kubernetes Services)
â€¢ Service Registry (Consul, etcd)
â€¢ Service Mesh (Istio, Linkerd)
```

**3. Data Consistency:**
```
ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°: Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ñ‹ Ğ¼ĞµĞ¶Ğ´Ñƒ ÑĞµÑ€Ğ²Ğ¸ÑĞ°Ğ¼Ğ¸
Ğ ĞµÑˆĞµĞ½Ğ¸Ñ:
â€¢ Event-Driven Architecture
â€¢ CQRS (Command Query Responsibility Segregation)
â€¢ API Composition Ğ´Ğ»Ñ Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ
```

**4. Observability:**
```
ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°: ĞÑ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ñ‡ĞµÑ€ĞµĞ· ÑĞµÑ€Ğ²Ğ¸ÑÑ‹
Ğ ĞµÑˆĞµĞ½Ğ¸Ñ:
â€¢ Distributed Tracing (Jaeger, Zipkin)
â€¢ Centralized Logging (ELK, Loki)
â€¢ Metrics (Prometheus, Grafana)
â€¢ Correlation IDs
```

**5. Network Latency:**
```
ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°: ĞœĞ½Ğ¾Ğ³Ğ¾ ÑĞµÑ‚ĞµĞ²Ñ‹Ñ… Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ²
Ğ ĞµÑˆĞµĞ½Ğ¸Ñ:
â€¢ Caching
â€¢ gRPC Ğ²Ğ¼ĞµÑÑ‚Ğ¾ REST
â€¢ Batch/Bulk APIs
â€¢ Async communication Ğ³Ğ´Ğµ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾
```

**Anti-patterns:**
- Distributed monolith (Ñ‚ĞµÑĞ½Ğ°Ñ ÑĞ²ÑĞ·ÑŒ Ğ¼ĞµĞ¶Ğ´Ñƒ ÑĞµÑ€Ğ²Ğ¸ÑĞ°Ğ¼Ğ¸)
- Shared database Ğ¼ĞµĞ¶Ğ´Ñƒ ÑĞµÑ€Ğ²Ğ¸ÑĞ°Ğ¼Ğ¸
- Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¼Ğ°Ğ»ĞµĞ½ÑŒĞºĞ¸Ğµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹ (nanoservices)

---

### 3. Load Balancing

**Ğ’Ğ¾Ğ¿Ñ€Ğ¾Ñ:** ĞĞ±ÑŠÑÑĞ½Ğ¸Ñ‚Ğµ Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼Ñ‹ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ¸Ñ€Ğ¾Ğ²ĞºĞ¸ (Round Robin, Least Connections, Consistent Hashing).

**ĞÑ‚Ğ²ĞµÑ‚:**

**Round Robin:**
```
Request 1 â†’ Server A
Request 2 â†’ Server B
Request 3 â†’ Server C
Request 4 â†’ Server A (Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€)
...
```
- ĞŸÑ€Ğ¾ÑÑ‚ĞµĞ¹ÑˆĞ¸Ğ¹ Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼
- Ğ Ğ°Ğ²Ğ½Ğ¾Ğ¼ĞµÑ€Ğ½Ğ¾Ğµ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ
- ĞĞµ ÑƒÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºÑƒ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ²
- **Weighted Round Robin:** ÑĞµÑ€Ğ²ĞµÑ€Ñ‹ Ñ Ñ€Ğ°Ğ·Ğ½Ñ‹Ğ¼ Ğ²ĞµÑĞ¾Ğ¼

**Least Connections:**
```
Server A: 5 connections  â†â”€â”€ Request (Ğ¸Ğ´ĞµÑ‚ ÑÑĞ´Ğ°)
Server B: 8 connections
Server C: 12 connections
```
- Ğ’Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ ÑĞµÑ€Ğ²ĞµÑ€ Ñ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼Ğ¾Ğ¼ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğ¹
- Ğ›ÑƒÑ‡ÑˆĞµ Ğ´Ğ»Ñ long-lived connections
- Ğ£Ñ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ‚ĞµĞºÑƒÑ‰ÑƒÑ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºÑƒ
- **Weighted Least Connections:** Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ Ğ¼Ğ¾Ñ‰Ğ½Ğ¾ÑÑ‚Ğ¸

**IP Hash:**
```
hash(client_ip) % num_servers â†’ Server
```
- ĞĞ´Ğ¸Ğ½ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¸Ğ´ĞµÑ‚ Ğ½Ğ° Ğ¾Ğ´Ğ¸Ğ½ ÑĞµÑ€Ğ²ĞµÑ€
- Session affinity Ğ±ĞµĞ· sticky sessions
- ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ğ¿Ñ€Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸/ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ²

**Consistent Hashing:**
```
          Server A
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚        â”‚        â”‚
Server D â”€â”€â”€â”€â—â”€â”€â”€â”€â”€ Server B
    â”‚        â”‚        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
          Server C

ĞšĞ»ÑÑ‡Ğ¸ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ÑÑÑ‚ÑÑ Ğ¿Ğ¾ ĞºĞ¾Ğ»ÑŒÑ†Ñƒ
ĞŸÑ€Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸/ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¸ ÑĞµÑ€Ğ²ĞµÑ€Ğ° Ğ¿ĞµÑ€ĞµĞ¼ĞµÑ‰Ğ°ĞµÑ‚ÑÑ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ ĞºĞ»ÑÑ‡ĞµĞ¹
```

- ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¿ĞµÑ€ĞµÑ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ²
- Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ²: ĞºĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, sharding
- **Virtual nodes:** Ñ€Ğ°Ğ²Ğ½Ğ¾Ğ¼ĞµÑ€Ğ½Ğ¾Ğµ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ

**Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ:**

| ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ | Use Case | ĞŸĞ»ÑÑÑ‹ | ĞœĞ¸Ğ½ÑƒÑÑ‹ |
|----------|----------|-------|--------|
| Round Robin | Stateless ÑĞµÑ€Ğ²Ğ¸ÑÑ‹ | ĞŸÑ€Ğ¾ÑÑ‚Ğ¾Ñ‚Ğ° | ĞĞµ ÑƒÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºÑƒ |
| Least Connections | Long-lived connections | ĞĞ´Ğ°Ğ¿Ñ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ | Overhead Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ |
| IP Hash | Session affinity | ĞŸÑ€Ğ¾ÑÑ‚Ğ°Ñ Ğ¿Ñ€Ğ¸Ğ²ÑĞ·ĞºĞ° | ĞĞµÑ€Ğ°Ğ²Ğ½Ğ¾Ğ¼ĞµÑ€Ğ½Ğ¾ÑÑ‚ÑŒ |
| Consistent Hashing | Distributed cache | ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµÑ‰ĞµĞ½Ğ¸Ğ¹ | Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ |

**L4 vs L7 Load Balancing:**
- **L4 (Transport):** TCP/UDP ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ, Ğ±Ñ‹ÑÑ‚Ñ€ĞµĞµ, Ğ¼ĞµĞ½ÑŒÑˆĞµ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ĞµĞ¹
- **L7 (Application):** HTTP ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ, routing Ğ¿Ğ¾ path/header, SSL termination

---

### 4. Database Sharding

**Ğ’Ğ¾Ğ¿Ñ€Ğ¾Ñ:** ĞĞ±ÑŠÑÑĞ½Ğ¸Ñ‚Ğµ Ğ³Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¸ Ğ²ĞµÑ€Ñ‚Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¿Ğ°Ñ€Ñ‚Ğ¸Ñ†Ğ¸Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ. ĞšĞ°Ğº Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ ĞºĞ»ÑÑ‡ ÑˆĞ°Ñ€Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ?

**ĞÑ‚Ğ²ĞµÑ‚:**

**Ğ’ĞµÑ€Ñ‚Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¿Ğ°Ñ€Ñ‚Ğ¸Ñ†Ğ¸Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Users Table               â”‚
â”‚ id â”‚ name â”‚ email â”‚ bio â”‚ avatar    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   users_core    â”‚  â”‚  users_profile  â”‚
â”‚ id â”‚ nameâ”‚email â”‚  â”‚ id â”‚ bioâ”‚avatar â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
- Ğ Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ°Ğ¼
- Ğ§Ğ°ÑÑ‚Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğµ vs Ñ€ĞµĞ´ĞºĞ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğµ
- ĞœĞ¸ĞºÑ€Ğ¾ÑĞµÑ€Ğ²Ğ¸ÑĞ½Ğ°Ñ Ğ´ĞµĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ

**Ğ“Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¿Ğ°Ñ€Ñ‚Ğ¸Ñ†Ğ¸Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ (Sharding):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Users (1-1M)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Shard 1     â”‚ â”‚   Shard 2     â”‚ â”‚   Shard 3     â”‚
â”‚  users 1-333K â”‚ â”‚users 333K-666Kâ”‚ â”‚users 666K-1M  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
- Ğ Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ¾ĞºĞ°Ğ¼
- ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ shard â€” Ğ½ĞµĞ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ°Ñ Ğ‘Ğ”

**Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¸ ÑˆĞ°Ñ€Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:**

**1. Range-based:**
```
Shard 1: user_id 1-1M
Shard 2: user_id 1M-2M
```
- ĞŸĞ»ÑÑÑ‹: range queries ÑÑ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹
- ĞœĞ¸Ğ½ÑƒÑÑ‹: hotspots, Ğ½ĞµÑ€Ğ°Ğ²Ğ½Ğ¾Ğ¼ĞµÑ€Ğ½Ğ¾ÑÑ‚ÑŒ

**2. Hash-based:**
```
shard = hash(user_id) % num_shards
```
- ĞŸĞ»ÑÑÑ‹: Ñ€Ğ°Ğ²Ğ½Ğ¾Ğ¼ĞµÑ€Ğ½Ğ¾Ğµ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ
- ĞœĞ¸Ğ½ÑƒÑÑ‹: range queries ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹, resharding Ğ±Ğ¾Ğ»ĞµĞ·Ğ½ĞµĞ½Ğ½Ñ‹Ğ¹

**3. Directory-based:**
```
Lookup Service: user_id â†’ shard_id
```
- ĞŸĞ»ÑÑÑ‹: Ğ³Ğ¸Ğ±ĞºĞ¾ÑÑ‚ÑŒ
- ĞœĞ¸Ğ½ÑƒÑÑ‹: single point of failure, latency

**Ğ’Ñ‹Ğ±Ğ¾Ñ€ ĞºĞ»ÑÑ‡Ğ° ÑˆĞ°Ñ€Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:**

| ĞšÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸Ğ¹ | Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¸Ğ¹ ĞºĞ»ÑÑ‡ | ĞŸĞ»Ğ¾Ñ…Ğ¾Ğ¹ ĞºĞ»ÑÑ‡ |
|----------|--------------|-------------|
| ĞšĞ°Ñ€Ğ´Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ | Ğ’Ñ‹ÑĞ¾ĞºĞ°Ñ (user_id) | ĞĞ¸Ğ·ĞºĞ°Ñ (status) |
| Ğ Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ | Ğ Ğ°Ğ²Ğ½Ğ¾Ğ¼ĞµÑ€Ğ½Ğ¾Ğµ | Skewed (created_date) |
| Query patterns | Ğ§Ğ°ÑÑ‚Ñ‹Ğ¹ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ | Ğ ĞµĞ´ĞºĞ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ |
| Hotspots | ĞĞµÑ‚ | Ğ•ÑÑ‚ÑŒ (celebrity user) |

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ´Ğ»Ñ Twitter:**
- **Tweets:** shard by user_id (Ğ²ÑĞµ Ñ‚Ğ²Ğ¸Ñ‚Ñ‹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ²Ğ¼ĞµÑÑ‚Ğµ)
- **Timeline:** shard by user_id (fan-out on write)
- **Search:** shard by tweet_id (Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ)

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ sharding:**
- Cross-shard queries (JOIN Ğ¼ĞµĞ¶Ğ´Ñƒ ÑˆĞ°Ñ€Ğ´Ğ°Ğ¼Ğ¸)
- Distributed transactions
- Resharding (Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑˆĞ°Ñ€Ğ´Ğ¾Ğ²)
- Referential integrity

---

### 5. Message Queues

**Ğ’Ğ¾Ğ¿Ñ€Ğ¾Ñ:** Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ñ‚Ğµ RabbitMQ Ğ¸ Kafka. ĞšĞ¾Ğ³Ğ´Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹?

**ĞÑ‚Ğ²ĞµÑ‚:**

**RabbitMQ:**
```
Producer â†’ Exchange â†’ Queue â†’ Consumer
                â†“
           Routing Key
```
- **ĞœĞ¾Ğ´ĞµĞ»ÑŒ:** Message Broker (smart broker, dumb consumer)
- **ĞŸÑ€Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ»:** AMQP
- **Delivery:** Push to consumers
- **Ordering:** Per queue
- **Retention:** Until consumed

**Kafka:**
```
Producer â†’ Topic (Partitions) â†’ Consumer Group
              â”‚
         [0][1][2]  â† Partitions
              â”‚
         Offset-based consumption
```
- **ĞœĞ¾Ğ´ĞµĞ»ÑŒ:** Distributed Log (dumb broker, smart consumer)
- **ĞŸÑ€Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ»:** Binary over TCP
- **Delivery:** Pull by consumers
- **Ordering:** Per partition
- **Retention:** Time/size based (replay possible)

**Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ:**

| ĞÑĞ¿ĞµĞºÑ‚ | RabbitMQ | Kafka |
|--------|----------|-------|
| Throughput | ~50K msg/s | ~1M+ msg/s |
| Latency | ĞĞ¸Ğ·ĞºĞ°Ñ | Ğ’Ñ‹ÑˆĞµ |
| Message size | ĞĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ¸Ğµ | Ğ›ÑĞ±Ñ‹Ğµ |
| Replay | ĞĞµÑ‚ | Ğ”Ğ° |
| Routing | Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ñ‹Ğ¹ (exchanges) | ĞŸÑ€Ğ¾ÑÑ‚Ğ¾Ğ¹ (topics) |
| Consumer groups | ĞĞµÑ‚ (Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ¾) | Ğ”Ğ° |
| Exactly-once | Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ğ¾ | ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ |
| Operations | ĞŸÑ€Ğ¾Ñ‰Ğµ | Ğ¡Ğ»Ğ¾Ğ¶Ğ½ĞµĞµ |

**ĞšĞ¾Ğ³Ğ´Ğ° RabbitMQ:**
- Task queues (background jobs)
- Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ğ°Ñ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
- RPC Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹
- ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ñ‹ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
- ĞĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹ Ğ¾Ğ±ÑŠĞµĞ¼, Ğ²Ğ°Ğ¶Ğ½Ğ° latency

**ĞšĞ¾Ğ³Ğ´Ğ° Kafka:**
- Event streaming
- Log aggregation
- Metrics collection
- Event sourcing
- Ğ’Ñ‹ÑĞ¾ĞºĞ¸Ğ¹ throughput
- ĞÑƒĞ¶ĞµĞ½ replay ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
- Real-time processing (Kafka Streams)

**ĞŸĞ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹:**

**Pub/Sub:**
```
RabbitMQ: Fanout Exchange â†’ Multiple Queues
Kafka: Topic â†’ Multiple Consumer Groups
```

**Work Queue:**
```
RabbitMQ: Single Queue â†’ Multiple Consumers (competing)
Kafka: Topic Partitions â†’ Consumer Group (each partition to one consumer)
```

---

### 6. Consistency Patterns

**Ğ’Ğ¾Ğ¿Ñ€Ğ¾Ñ:** ĞĞ±ÑŠÑÑĞ½Ğ¸Ñ‚Ğµ eventual consistency, strong consistency Ğ¸ SAGA pattern.

**ĞÑ‚Ğ²ĞµÑ‚:**

**Strong Consistency:**
```
Write â”€â”€â–º All nodes updated â”€â”€â–º Read sees latest
              (synchronous)
```
- ĞŸĞ¾ÑĞ»Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ²ÑĞµ Ñ‡Ğ¸Ñ‚Ğ°ÑÑ‚ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
- Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾Ğ¹ Ñ€ĞµĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸
- Ğ’Ñ‹ÑˆĞµ latency, Ğ½Ğ¸Ğ¶Ğµ availability
- **ĞŸÑ€Ğ¸Ğ¼ĞµÑ€:** PostgreSQL synchronous replication

**Eventual Consistency:**
```
Write â”€â”€â–º Primary updated â”€â”€â–º Async replication â”€â”€â–º Eventually all nodes
                                                    see latest
```
- Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ "Ğ² ĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾Ğ¼ ÑÑ‡ĞµÑ‚Ğµ" ÑÑ‚Ğ°Ğ½ÑƒÑ‚ ĞºĞ¾Ğ½ÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ½Ñ‹Ğ¼Ğ¸
- ĞĞºĞ½Ğ¾ Ğ½ĞµÑĞ¾Ğ³Ğ»Ğ°ÑĞ¾Ğ²Ğ°Ğ½Ğ½Ğ¾ÑÑ‚Ğ¸
- ĞĞ¸Ğ¶Ğµ latency, Ğ²Ñ‹ÑˆĞµ availability
- **ĞŸÑ€Ğ¸Ğ¼ĞµÑ€:** DynamoDB, Cassandra

**Read-Your-Writes:**
```
Write â”€â”€â–º Read from same node â”€â”€â–º See your write
               OR
         Write timestamp check
```
- Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ ÑĞ²Ğ¾Ğ¸ ÑĞ¾Ğ±ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸
- ĞšĞ¾Ğ¼Ğ¿Ñ€Ğ¾Ğ¼Ğ¸ÑÑ Ğ¼ĞµĞ¶Ğ´Ñƒ strong Ğ¸ eventual

**SAGA Pattern:**

Ğ”Ğ»Ñ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ½Ñ‹Ñ… Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹ Ğ±ĞµĞ· 2PC.

**Choreography (ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   OrderCreated   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   PaymentDone   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Orders  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ Payment â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚Shipping â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                            â”‚                            â”‚
     â”‚      PaymentFailed         â”‚                            â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
     â”‚      (compensate)          â”‚                            â”‚
```

**Orchestration (ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ğ¾Ñ€):**
```
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   SAGA      â”‚
                  â”‚ Orchestratorâ”‚
                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â–¼             â–¼             â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Orders  â”‚   â”‚ Payment â”‚   â”‚Shipping â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Compensating transactions:**
```
1. Create Order â†’ success
2. Reserve Inventory â†’ success  
3. Process Payment â†’ FAIL
4. Compensate: Release Inventory
5. Compensate: Cancel Order
```

**SAGA vs 2PC:**

| ĞÑĞ¿ĞµĞºÑ‚ | SAGA | 2PC |
|--------|------|-----|
| Isolation | ĞĞµÑ‚ | Ğ”Ğ° |
| Blocking | ĞĞµÑ‚ | Ğ”Ğ° |
| Rollback | Compensations | Automatic |
| Complexity | Ğ’Ñ‹ÑˆĞµ | ĞĞ¸Ğ¶Ğµ |
| Scalability | Ğ›ÑƒÑ‡ÑˆĞµ | Ğ¥ÑƒĞ¶Ğµ |

---

### 7. Caching Layers

**Ğ’Ğ¾Ğ¿Ñ€Ğ¾Ñ:** ĞšĞ°Ğº Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ÑƒÑ€Ğ¾Ğ²Ğ½ĞµĞ²Ğ¾Ğµ ĞºĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ (CDN, Redis, Application Cache)?

**ĞÑ‚Ğ²ĞµÑ‚:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Caching Layers                            â”‚
â”‚                                                              â”‚
â”‚   User Request                                               â”‚
â”‚        â”‚                                                     â”‚
â”‚        â–¼                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  L1: Edge Cache                               â”‚
â”‚   â”‚   CDN   â”‚  â€¢ Static assets (images, JS, CSS)            â”‚
â”‚   â”‚         â”‚  â€¢ HTML pages (if cacheable)                  â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â€¢ TTL: minutes to days                       â”‚
â”‚        â”‚                                                     â”‚
â”‚        â–¼                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  L2: API Gateway Cache                        â”‚
â”‚   â”‚ Gateway â”‚  â€¢ Full response caching                      â”‚
â”‚   â”‚ Cache   â”‚  â€¢ Rate limiting cache                        â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â€¢ TTL: seconds to minutes                    â”‚
â”‚        â”‚                                                     â”‚
â”‚        â–¼                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  L3: Application Cache (in-memory)            â”‚
â”‚   â”‚ App     â”‚  â€¢ Frequently accessed data                   â”‚
â”‚   â”‚ Memory  â”‚  â€¢ Computed values                            â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â€¢ Per-instance, not shared                   â”‚
â”‚        â”‚                                                     â”‚
â”‚        â–¼                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  L4: Distributed Cache                        â”‚
â”‚   â”‚  Redis  â”‚  â€¢ Session data                               â”‚
â”‚   â”‚ Cluster â”‚  â€¢ User profiles                              â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â€¢ Hot data                                   â”‚
â”‚        â”‚       â€¢ TTL: configurable                          â”‚
â”‚        â–¼                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  L5: Database Query Cache                     â”‚
â”‚   â”‚   DB    â”‚  â€¢ Query result cache                         â”‚
â”‚   â”‚ Cache   â”‚  â€¢ Buffer pool                                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**CDN (Content Delivery Network):**
```
â€¢ Cache-Control headers
â€¢ Edge locations (Ğ±Ğ»Ğ¸Ğ·ĞºĞ¾ Ğº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ)
â€¢ Static: Ğ´Ğ¾Ğ»Ğ³Ğ¸Ğ¹ TTL + versioned URLs
â€¢ Dynamic: ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¹ TTL Ğ¸Ğ»Ğ¸ stale-while-revalidate
```

**Redis Cluster:**
```javascript
// Cache-aside pattern
async function getUser(id) {
  const cached = await redis.get(`user:${id}`);
  if (cached) return JSON.parse(cached);
  
  const user = await db.users.findById(id);
  await redis.setex(`user:${id}`, 3600, JSON.stringify(user));
  return user;
}
```

**Application-level cache:**
```javascript
// In-memory (per instance)
const cache = new Map();
// Ğ¸Ğ»Ğ¸ LRU cache
import LRU from 'lru-cache';
const cache = new LRU({ max: 500, ttl: 1000 * 60 * 5 });
```

**Cache invalidation strategies:**
- **TTL-based:** Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¸ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸Ğµ
- **Event-based:** invalidate Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸
- **Write-through:** Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑÑ‚ÑŒ ĞºĞµÑˆ Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸

**Cache warming:**
```javascript
// ĞŸÑ€ĞµĞ´Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ğ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ğµ
async function warmCache() {
  const popularItems = await db.items.findPopular(1000);
  await Promise.all(
    popularItems.map(item => 
      redis.setex(`item:${item.id}`, 3600, JSON.stringify(item))
    )
  );
}
```

---

### 8. API Gateway

**Ğ’Ğ¾Ğ¿Ñ€Ğ¾Ñ:** Ğ—Ğ°Ñ‡ĞµĞ¼ Ğ½ÑƒĞ¶ĞµĞ½ API Gateway? ĞšĞ°ĞºĞ¸Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ¾Ğ½ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚?

**ĞÑ‚Ğ²ĞµÑ‚:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      API Gateway                             â”‚
â”‚                                                              â”‚
â”‚   Clients                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”                                   â”‚
â”‚   â”‚ Web â”‚ â”‚Mobileâ”‚ â”‚ IoT â”‚                                   â”‚
â”‚   â””â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”˜                                   â”‚
â”‚      â”‚       â”‚       â”‚                                       â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚              â–¼                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚   â”‚              API Gateway                  â”‚              â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚              â”‚
â”‚   â”‚  â”‚ â€¢ Authentication / Authorization   â”‚  â”‚              â”‚
â”‚   â”‚  â”‚ â€¢ Rate Limiting                    â”‚  â”‚              â”‚
â”‚   â”‚  â”‚ â€¢ Request/Response Transformation  â”‚  â”‚              â”‚
â”‚   â”‚  â”‚ â€¢ Load Balancing                   â”‚  â”‚              â”‚
â”‚   â”‚  â”‚ â€¢ Caching                          â”‚  â”‚              â”‚
â”‚   â”‚  â”‚ â€¢ SSL Termination                  â”‚  â”‚              â”‚
â”‚   â”‚  â”‚ â€¢ Logging / Monitoring             â”‚  â”‚              â”‚
â”‚   â”‚  â”‚ â€¢ Circuit Breaker                  â”‚  â”‚              â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚              â”‚                                               â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚      â–¼       â–¼       â–¼       â–¼                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”                          â”‚
â”‚   â”‚Usersâ”‚ â”‚Ordersâ”‚ â”‚Paym.â”‚ â”‚Notifâ”‚                          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ API Gateway:**

**1. Authentication & Authorization:**
```
â€¢ JWT validation
â€¢ OAuth2 / OIDC
â€¢ API Keys
â€¢ ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ° user context Ğ² Ğ¼Ğ¸ĞºÑ€Ğ¾ÑĞµÑ€Ğ²Ğ¸ÑÑ‹
```

**2. Rate Limiting:**
```
â€¢ Per user / IP / API key
â€¢ Global limits
â€¢ Quota management
```

**3. Request Transformation:**
```
â€¢ Protocol translation (REST â†’ gRPC)
â€¢ Request/response mapping
â€¢ Header manipulation
â€¢ API versioning
```

**4. Load Balancing:**
```
â€¢ Round robin
â€¢ Weighted
â€¢ Health checks
```

**5. Caching:**
```
â€¢ Response caching
â€¢ Cache invalidation
```

**6. Circuit Breaker:**
```
â€¢ Prevent cascade failures
â€¢ Fallback responses
```

**7. Observability:**
```
â€¢ Request logging
â€¢ Metrics collection
â€¢ Distributed tracing
â€¢ Error tracking
```

**Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹:**
- **Kong:** Open source, plugin ecosystem
- **AWS API Gateway:** Managed, serverless integration
- **Nginx/HAProxy:** Lightweight, custom config
- **Envoy:** Cloud-native, service mesh ready
- **Traefik:** Kubernetes native

**BFF (Backend for Frontend):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Web   â”‚â”€â”€â”€â”€â–ºâ”‚ Web BFF â”‚â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mobile  â”‚â”€â”€â”€â”€â–ºâ”‚Mobile BFFâ”‚â”€â–ºâ”‚ Microservicesâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
- ĞÑ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ gateway Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ñ‚Ğ¸Ğ¿Ğ° ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°
- ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹

---

### 9. Circuit Breaker

**Ğ’Ğ¾Ğ¿Ñ€Ğ¾Ñ:** ĞĞ±ÑŠÑÑĞ½Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½ Circuit Breaker. ĞšĞ°Ğº Ğ¾Ğ½ Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°ĞµÑ‚ Ğ² Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ½Ñ‹Ñ… ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°Ñ…?

**ĞÑ‚Ğ²ĞµÑ‚:**

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** Cascade failures Ğ² Ğ¼Ğ¸ĞºÑ€Ğ¾ÑĞµÑ€Ğ²Ğ¸ÑĞ°Ñ….

```
Service A â†’ Service B (down) â†’ timeout â†’ retry â†’ more load â†’ cascading failure
```

**Circuit Breaker States:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Circuit Breaker                           â”‚
â”‚                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    failures >= threshold    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚ CLOSED  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚  OPEN   â”‚       â”‚
â”‚   â”‚         â”‚                             â”‚         â”‚       â”‚
â”‚   â”‚ Normal  â”‚                             â”‚ Fail    â”‚       â”‚
â”‚   â”‚ operationâ”‚                             â”‚ fast    â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                             â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â”‚
â”‚        â–²                                       â”‚             â”‚
â”‚        â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚             â”‚
â”‚        â”‚  success  â”‚ HALF-OPEN   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚   timeout                 â”‚
â”‚                    â”‚ Test single â”‚                           â”‚
â”‚                    â”‚ request     â”‚                           â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                           â”‚                                  â”‚
â”‚                           â”‚ failure                          â”‚
â”‚                           â–¼                                  â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚                    â”‚  OPEN   â”‚                               â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ:**

**CLOSED (Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ):**
- Ğ—Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¿Ñ€Ğ¾Ñ…Ğ¾Ğ´ÑÑ‚ Ñ‡ĞµÑ€ĞµĞ· circuit breaker
- ĞÑ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°ÑÑ‚ÑÑ failures
- ĞŸÑ€Ğ¸ Ğ´Ğ¾ÑÑ‚Ğ¸Ğ¶ĞµĞ½Ğ¸Ğ¸ threshold â†’ OPEN

**OPEN:**
- Ğ—Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ ÑÑ€Ğ°Ğ·Ñƒ reject (fail fast)
- Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ÑÑ fallback Ğ¸Ğ»Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°
- ĞĞµ Ğ½Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ failing service
- ĞŸĞ¾ÑĞ»Ğµ timeout â†’ HALF-OPEN

**HALF-OPEN:**
- ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ½Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
- Ğ•ÑĞ»Ğ¸ ÑƒÑĞ¿ĞµÑ… â†’ CLOSED
- Ğ•ÑĞ»Ğ¸ failure â†’ OPEN

**ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ:**
```javascript
const breaker = new CircuitBreaker(asyncFunction, {
  timeout: 3000,           // Ğ¢Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°
  errorThresholdPercentage: 50,  // % Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ´Ğ»Ñ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ
  resetTimeout: 30000,     // Ğ’Ñ€ĞµĞ¼Ñ Ğ² OPEN Ğ´Ğ¾ HALF-OPEN
  volumeThreshold: 10,     // ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ´Ğ»Ñ Ğ¾Ñ†ĞµĞ½ĞºĞ¸
});

breaker.fallback(() => cachedValue);
breaker.on('open', () => alert('Circuit opened'));
breaker.on('halfOpen', () => log('Testing service'));
breaker.on('close', () => log('Service recovered'));
```

**Fallback ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¸:**
- Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚ ĞºĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
- Default Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
- Degraded response
- Alternative service

**ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ°:**
- Circuit state changes
- Failure rate
- Response times
- Fallback usage

**Ğ‘Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ¸:**
- **Node.js:** opossum
- **Java:** Resilience4j, Hystrix (deprecated)
- **Service Mesh:** Istio, Linkerd (Ğ½Ğ° ÑƒÑ€Ğ¾Ğ²Ğ½Ğµ ÑĞµÑ‚Ğ¸)

---

### 10. Observability

**Ğ’Ğ¾Ğ¿Ñ€Ğ¾Ñ:** Ğ§Ñ‚Ğ¾ Ñ‚Ğ°ĞºĞ¾Ğµ Three Pillars of Observability (Logs, Metrics, Traces)? ĞšĞ°ĞºĞ¸Ğµ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ?

**ĞÑ‚Ğ²ĞµÑ‚:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Three Pillars of Observability                 â”‚
â”‚                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚   â”‚    LOGS     â”‚  â”‚   METRICS   â”‚  â”‚   TRACES    â”‚        â”‚
â”‚   â”‚             â”‚  â”‚             â”‚  â”‚             â”‚        â”‚
â”‚   â”‚ What        â”‚  â”‚ How much?   â”‚  â”‚ Where?      â”‚        â”‚
â”‚   â”‚ happened?   â”‚  â”‚ How often?  â”‚  â”‚ How long?   â”‚        â”‚
â”‚   â”‚             â”‚  â”‚             â”‚  â”‚             â”‚        â”‚
â”‚   â”‚ Discrete    â”‚  â”‚ Aggregated  â”‚  â”‚ Distributed â”‚        â”‚
â”‚   â”‚ events      â”‚  â”‚ numbers     â”‚  â”‚ path        â”‚        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                              â”‚
â”‚   Examples:        Examples:        Examples:               â”‚
â”‚   â€¢ Error logs     â€¢ CPU usage      â€¢ Request flow          â”‚
â”‚   â€¢ Request logs   â€¢ Memory         â€¢ Service latency       â”‚
â”‚   â€¢ Audit logs     â€¢ Request rate   â€¢ Dependencies          â”‚
â”‚   â€¢ Debug info     â€¢ Error rate     â€¢ Bottlenecks           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**LOGS:**
```json
{
  "timestamp": "2024-01-15T10:30:00Z",
  "level": "error",
  "service": "payment-service",
  "trace_id": "abc123",
  "message": "Payment failed",
  "error": "Card declined",
  "user_id": "user_456",
  "amount": 100.00
}
```

**Structured logging:**
- JSON format
- Consistent fields
- Correlation IDs
- Log levels

**Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹:**
- **Collection:** Fluentd, Filebeat, Vector
- **Storage:** Elasticsearch, Loki
- **UI:** Kibana, Grafana

**METRICS:**
```
# Counter (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ€Ğ°ÑÑ‚ĞµÑ‚)
http_requests_total{method="GET", status="200"} 1234

# Gauge (Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ)
memory_usage_bytes 1234567890

# Histogram (Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ)
http_request_duration_seconds_bucket{le="0.1"} 1000
http_request_duration_seconds_bucket{le="0.5"} 1500

# Summary (percentiles)
http_request_duration_seconds{quantile="0.99"} 0.234
```

**Ğ¢Ğ¸Ğ¿Ñ‹ Ğ¼ĞµÑ‚Ñ€Ğ¸Ğº:**
- **RED:** Rate, Errors, Duration (Ğ´Ğ»Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²)
- **USE:** Utilization, Saturation, Errors (Ğ´Ğ»Ñ Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ²)

**Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹:**
- **Collection:** Prometheus, StatsD
- **Storage:** Prometheus, InfluxDB, VictoriaMetrics
- **UI:** Grafana
- **Alerting:** Alertmanager, PagerDuty

**TRACES:**
```
Trace ID: abc123
â”œâ”€ Span: API Gateway (10ms)
â”‚  â””â”€ Span: Auth Service (5ms)
â”œâ”€ Span: User Service (20ms)
â”‚  â”œâ”€ Span: Database Query (15ms)
â”‚  â””â”€ Span: Cache Lookup (2ms)
â””â”€ Span: Notification Service (8ms)
```

**ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹:**
- **Trace:** ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¿ÑƒÑ‚ÑŒ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°
- **Span:** Ğ•Ğ´Ğ¸Ğ½Ğ¸Ñ†Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ (ÑĞµÑ€Ğ²Ğ¸Ñ, Ğ‘Ğ” Ğ²Ñ‹Ğ·Ğ¾Ğ²)
- **Context Propagation:** ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ° trace ID Ğ¼ĞµĞ¶Ğ´Ñƒ ÑĞµÑ€Ğ²Ğ¸ÑĞ°Ğ¼Ğ¸

**Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹:**
- **Collection:** OpenTelemetry, Jaeger Agent
- **Storage:** Jaeger, Tempo
- **UI:** Jaeger UI, Grafana Tempo

**OpenTelemetry:**
```javascript
// Unified API Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ñ‚Ñ€ĞµÑ… pillars
const { trace, metrics, logs } = require('@opentelemetry/api');

const tracer = trace.getTracer('my-service');
const span = tracer.startSpan('processOrder');
// ... work ...
span.end();
```

**Correlation:**
```
Trace ID ÑĞ²ÑĞ·Ñ‹Ğ²Ğ°ĞµÑ‚:
- Logs: "trace_id": "abc123"
- Metrics: trace_id label
- Traces: span context
```

---

## ğŸ’» ĞŸÑ€Ğ°ĞºÑ‚Ğ¸ĞºĞ° / System Design Tasks

### 1. URL Shortener

**Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ°:** Ğ¡Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ ÑĞµÑ€Ğ²Ğ¸Ñ ÑĞ¾ĞºÑ€Ğ°Ñ‰ĞµĞ½Ğ¸Ñ ÑÑÑ‹Ğ»Ğ¾Ğº.

**ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    URL Shortener Architecture                â”‚
â”‚                                                              â”‚
â”‚  Requirements:                                               â”‚
â”‚  â€¢ 100M URLs/day write, 10B reads/day                       â”‚
â”‚  â€¢ Short URL: 7 characters                                   â”‚
â”‚  â€¢ Analytics: click counts, geography                        â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    High-Level Design                    â”‚â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚   User â”€â”€â–º Load Balancer â”€â”€â–º API Servers â”€â”€â–º Database   â”‚â”‚
â”‚  â”‚              â”‚                    â”‚                     â”‚â”‚
â”‚  â”‚              â”‚                    â–¼                     â”‚â”‚
â”‚  â”‚              â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚â”‚
â”‚  â”‚              â”‚              â”‚  Cache   â”‚               â”‚â”‚
â”‚  â”‚              â”‚              â”‚ (Redis)  â”‚               â”‚â”‚
â”‚  â”‚              â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚â”‚
â”‚  â”‚              â”‚                                         â”‚â”‚
â”‚  â”‚              â–¼                                         â”‚â”‚
â”‚  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚â”‚
â”‚  â”‚         â”‚   CDN    â”‚                                   â”‚â”‚
â”‚  â”‚         â”‚(redirect)â”‚                                   â”‚â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                              â”‚
â”‚  URL Generation Options:                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ 1. Counter + Base62 encoding                            â”‚â”‚
â”‚  â”‚    â€¢ Centralized counter (Redis INCR)                   â”‚â”‚
â”‚  â”‚    â€¢ Range-based distributed (ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ ÑĞµÑ€Ğ²ĞµÑ€ ÑĞ²Ğ¾Ğ¹ range) â”‚â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚ 2. Hash (MD5/SHA) + take first 7 chars                  â”‚â”‚
â”‚  â”‚    â€¢ ĞšĞ¾Ğ»Ğ»Ğ¸Ğ·Ğ¸Ğ¸ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹ â†’ retry                          â”‚â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚ 3. Pre-generated keys                                   â”‚â”‚
â”‚  â”‚    â€¢ Key Generation Service                             â”‚â”‚
â”‚  â”‚    â€¢ Two tables: available, used                        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                              â”‚
â”‚  Database Schema:                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ urls:                                                   â”‚â”‚
â”‚  â”‚   short_code (PK, VARCHAR(7))                           â”‚â”‚
â”‚  â”‚   original_url (TEXT)                                   â”‚â”‚
â”‚  â”‚   user_id (FK)                                          â”‚â”‚
â”‚  â”‚   created_at (TIMESTAMP)                                â”‚â”‚
â”‚  â”‚   expires_at (TIMESTAMP)                                â”‚â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚ analytics (Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ°Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°, async write):             â”‚â”‚
â”‚  â”‚   short_code                                            â”‚â”‚
â”‚  â”‚   clicked_at                                            â”‚â”‚
â”‚  â”‚   ip_address                                            â”‚â”‚
â”‚  â”‚   user_agent                                            â”‚â”‚
â”‚  â”‚   referrer                                              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                              â”‚
â”‚  Scaling:                                                    â”‚
â”‚  â€¢ Database: sharding by short_code                         â”‚
â”‚  â€¢ Cache: hot URLs in Redis                                 â”‚
â”‚  â€¢ CDN: 301/302 redirects at edge                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key decisions:**
- **7 chars Base62:** 62^7 = 3.5 trillion URLs
- **301 vs 302:** 301 (permanent) cacheable, 302 (temporary) for analytics
- **Write path:** async analytics, sync URL creation
- **Read path:** Cache â†’ DB, 99% cache hit rate

---

### 2. News Feed

**Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ°:** Ğ¡Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ğ»ĞµĞ½Ñ‚Ñƒ Ğ½Ğ¾Ğ²Ğ¾ÑÑ‚ĞµĞ¹ (Fan-out on write vs read).

**ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    News Feed Architecture                    â”‚
â”‚                                                              â”‚
â”‚  Two Approaches:                                             â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚              Fan-out on Write (Push)                    â”‚â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚  User posts â”€â”€â–º Write to all followers' feeds           â”‚â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚  Post â”€â”€â–º Fanout Service â”€â”€â–º [Feed 1][Feed 2]...[Feed N]â”‚â”‚
â”‚  â”‚              â”‚                                          â”‚â”‚
â”‚  â”‚              â”‚  For celebrity (1M followers):           â”‚â”‚
â”‚  â”‚              â”‚  1M write operations!                    â”‚â”‚
â”‚  â”‚              â”‚                                          â”‚â”‚
â”‚  â”‚  Pros: Fast reads (pre-computed)                        â”‚â”‚
â”‚  â”‚  Cons: Slow writes, storage heavy, stale for inactive   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚              Fan-out on Read (Pull)                     â”‚â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚  User requests feed â”€â”€â–º Aggregate from all followings   â”‚â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚  Request â”€â”€â–º Fetch posts â”€â”€â–º Merge â”€â”€â–º Sort â”€â”€â–º Return  â”‚â”‚
â”‚  â”‚              from each                                  â”‚â”‚
â”‚  â”‚              following                                  â”‚â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚  Pros: Fresh data, simple writes                        â”‚â”‚
â”‚  â”‚  Cons: Slow reads, high read amplification              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                              â”‚
â”‚  Hybrid Approach (Twitter/Facebook):                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚  Regular users (< 10K followers): Fan-out on write      â”‚â”‚
â”‚  â”‚  Celebrities (> 10K followers): Fan-out on read         â”‚â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚  Post â”€â”€â–º Is celebrity?                                 â”‚â”‚
â”‚  â”‚              â”‚                                          â”‚â”‚
â”‚  â”‚         No  â”‚  Yes                                      â”‚â”‚
â”‚  â”‚              â–¼                                          â”‚â”‚
â”‚  â”‚         Fanout to    Store in celebrity                 â”‚â”‚
â”‚  â”‚         all feeds    posts cache                        â”‚â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚  Read: Merge pre-computed feed + celebrity posts        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                              â”‚
â”‚  Feed Storage:                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Redis Sorted Set per user:                              â”‚â”‚
â”‚  â”‚   Key: feed:{user_id}                                   â”‚â”‚
â”‚  â”‚   Score: timestamp                                      â”‚â”‚
â”‚  â”‚   Value: post_id                                        â”‚â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚ ZREVRANGE feed:123 0 20 â†’ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 20 Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ²           â”‚â”‚
â”‚  â”‚ ZADD feed:123 {timestamp} {post_id}                     â”‚â”‚
â”‚  â”‚ ZREMRANGEBYRANK feed:123 0 -1001 â†’ keep 1000 latest     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Components:**
- **Post Service:** ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ²
- **Fanout Service:** Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ feeds (async, queue)
- **Feed Service:** Ñ‡Ñ‚ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ°Ğ³Ñ€ĞµĞ³Ğ°Ñ†Ğ¸Ñ
- **Ranking Service:** Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ, ML ranking

---

### 3. Chat System

**Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ°:** Ğ¡Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ Ğ¼Ğ³Ğ½Ğ¾Ğ²ĞµĞ½Ğ½Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹.

**ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Chat System Architecture                  â”‚
â”‚                                                              â”‚
â”‚  Requirements:                                               â”‚
â”‚  â€¢ 1:1 and group chats                                      â”‚
â”‚  â€¢ Online status                                            â”‚
â”‚  â€¢ Message delivery guarantees                              â”‚
â”‚  â€¢ Push notifications                                       â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    Connection Layer                     â”‚â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚  Client â—„â”€â”€WebSocketâ”€â”€â–º Load Balancer â—„â”€â”€â–º WS Servers   â”‚â”‚
â”‚  â”‚                              â”‚                          â”‚â”‚
â”‚  â”‚                              â”‚ Sticky sessions          â”‚â”‚
â”‚  â”‚                              â”‚ (user â†’ server mapping)  â”‚â”‚
â”‚  â”‚                              â–¼                          â”‚â”‚
â”‚  â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚â”‚
â”‚  â”‚                         â”‚  Redis  â”‚                     â”‚â”‚
â”‚  â”‚                         â”‚ Pub/Sub â”‚                     â”‚â”‚
â”‚  â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                              â”‚
â”‚  Message Flow:                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ 1. Client A sends message via WebSocket                 â”‚â”‚
â”‚  â”‚ 2. WS Server receives, generates message_id             â”‚â”‚
â”‚  â”‚ 3. Store message in DB (async via queue)                â”‚â”‚
â”‚  â”‚ 4. ACK to Client A (message_id, sent status)            â”‚â”‚
â”‚  â”‚ 5. Find Client B's WS server (Redis lookup)             â”‚â”‚
â”‚  â”‚ 6. If online: deliver via Redis Pub/Sub                 â”‚â”‚
â”‚  â”‚    If offline: store in undelivered queue               â”‚â”‚
â”‚  â”‚ 7. Client B receives â†’ ACK â†’ mark delivered             â”‚â”‚
â”‚  â”‚ 8. Client B reads â†’ mark read                           â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                              â”‚
â”‚  Message States:                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ SENT â†’ DELIVERED â†’ READ                                 â”‚â”‚
â”‚  â”‚   â”‚                                                     â”‚â”‚
â”‚  â”‚   â””â”€â–º (tick) (double tick) (blue tick - WhatsApp style) â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                              â”‚
â”‚  Data Model:                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ messages:                                               â”‚â”‚
â”‚  â”‚   message_id (UUID)                                     â”‚â”‚
â”‚  â”‚   conversation_id                                       â”‚â”‚
â”‚  â”‚   sender_id                                             â”‚â”‚
â”‚  â”‚   content (encrypted)                                   â”‚â”‚
â”‚  â”‚   type (text, image, file)                              â”‚â”‚
â”‚  â”‚   created_at                                            â”‚â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚ conversations:                                          â”‚â”‚
â”‚  â”‚   conversation_id                                       â”‚â”‚
â”‚  â”‚   type (1:1, group)                                     â”‚â”‚
â”‚  â”‚   participants[]                                        â”‚â”‚
â”‚  â”‚   last_message_at                                       â”‚â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚ message_status:                                         â”‚â”‚
â”‚  â”‚   message_id                                            â”‚â”‚
â”‚  â”‚   user_id                                               â”‚â”‚
â”‚  â”‚   status (sent, delivered, read)                        â”‚â”‚
â”‚  â”‚   timestamp                                             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                              â”‚
â”‚  Offline Handling:                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ 1. Push notification (FCM/APNs)                         â”‚â”‚
â”‚  â”‚ 2. Store in pending queue                               â”‚â”‚
â”‚  â”‚ 3. On reconnect: sync messages (last_seen_message_id)   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key considerations:**
- **WebSocket** Ğ´Ğ»Ñ real-time
- **Redis Pub/Sub** Ğ´Ğ»Ñ cross-server communication
- **Message queue** Ğ´Ğ»Ñ persistence
- **E2E encryption** Ğ´Ğ»Ñ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸

---

### 4. Rate Limiter Service

**Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ°:** Ğ¡Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ½Ñ‹Ğ¹ rate limiter Ğ´Ğ»Ñ API.

**ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Distributed Rate Limiter                      â”‚
â”‚                                                              â”‚
â”‚  Algorithms:                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ 1. Token Bucket                                         â”‚â”‚
â”‚  â”‚    â€¢ Bucket fills with tokens at fixed rate             â”‚â”‚
â”‚  â”‚    â€¢ Request consumes token                             â”‚â”‚
â”‚  â”‚    â€¢ Allows bursts (up to bucket size)                  â”‚â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚ 2. Sliding Window Log                                   â”‚â”‚
â”‚  â”‚    â€¢ Store timestamps of requests                       â”‚â”‚
â”‚  â”‚    â€¢ Count requests in window                           â”‚â”‚
â”‚  â”‚    â€¢ Accurate but memory intensive                      â”‚â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚ 3. Sliding Window Counter                               â”‚â”‚
â”‚  â”‚    â€¢ Combine fixed windows with weighted average        â”‚â”‚
â”‚  â”‚    â€¢ Memory efficient                                   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                              â”‚
â”‚  Architecture:                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚  Request â”€â”€â–º API Gateway â”€â”€â–º Rate Limiter â”€â”€â–º Service   â”‚â”‚
â”‚  â”‚                    â”‚              â”‚                     â”‚â”‚
â”‚  â”‚                    â”‚              â–¼                     â”‚â”‚
â”‚  â”‚                    â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚â”‚
â”‚  â”‚                    â”‚         â”‚  Redis  â”‚               â”‚â”‚
â”‚  â”‚                    â”‚         â”‚ Cluster â”‚               â”‚â”‚
â”‚  â”‚                    â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚â”‚
â”‚  â”‚                    â”‚                                    â”‚â”‚
â”‚  â”‚                    â–¼                                    â”‚â”‚
â”‚  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚â”‚
â”‚  â”‚              â”‚  Rules   â”‚                               â”‚â”‚
â”‚  â”‚              â”‚  Config  â”‚                               â”‚â”‚
â”‚  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                              â”‚
â”‚  Redis Implementation (Token Bucket with Lua):               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Key: rate_limit:{user_id}:{endpoint}                    â”‚â”‚
â”‚  â”‚ Value: {tokens: N, last_refill: timestamp}              â”‚â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚ Lua script (atomic):                                    â”‚â”‚
â”‚  â”‚   1. Get current tokens and last_refill                 â”‚â”‚
â”‚  â”‚   2. Calculate tokens to add based on elapsed time      â”‚â”‚
â”‚  â”‚   3. If tokens >= 1: allow, decrement                   â”‚â”‚
â”‚  â”‚   4. Else: reject, return retry_after                   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                              â”‚
â”‚  Multi-tier Limits:                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ â€¢ Per IP: 100 req/min (DDoS protection)                 â”‚â”‚
â”‚  â”‚ â€¢ Per User: 1000 req/min (fair usage)                   â”‚â”‚
â”‚  â”‚ â€¢ Per Endpoint: varies (expensive endpoints)            â”‚â”‚
â”‚  â”‚ â€¢ Global: 1M req/min (system protection)                â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                              â”‚
â”‚  Response Headers:                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ X-RateLimit-Limit: 100                                  â”‚â”‚
â”‚  â”‚ X-RateLimit-Remaining: 45                               â”‚â”‚
â”‚  â”‚ X-RateLimit-Reset: 1640000000                           â”‚â”‚
â”‚  â”‚ Retry-After: 30 (when 429)                              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 5. File Storage System

**Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ°:** Ğ¡Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ñ‚Ğ¸Ğ¿Ğ° Dropbox.

**ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 File Storage Architecture                    â”‚
â”‚                                                              â”‚
â”‚  Requirements:                                               â”‚
â”‚  â€¢ Upload/download files                                    â”‚
â”‚  â€¢ Sync across devices                                      â”‚
â”‚  â€¢ File versioning                                          â”‚
â”‚  â€¢ Sharing                                                  â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    Upload Flow                          â”‚â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚  Client â”€â”€â–º Chunking â”€â”€â–º Dedup Check â”€â”€â–º Upload Chunks  â”‚â”‚
â”‚  â”‚               â”‚              â”‚                â”‚         â”‚â”‚
â”‚  â”‚            4MB each    Hash exists?      Block Storage  â”‚â”‚
â”‚  â”‚                              â”‚                          â”‚â”‚
â”‚  â”‚                              â–¼                          â”‚â”‚
â”‚  â”‚                         Metadata DB                     â”‚â”‚
â”‚  â”‚                         (file â†’ chunks)                 â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                              â”‚
â”‚  File Chunking & Deduplication:                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚  File (100MB)                                           â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚
â”‚  â”‚  â”‚ Chunk1 â”‚ Chunk2 â”‚ Chunk3 â”‚ ... â”‚ Chunk25           â”‚ â”‚â”‚
â”‚  â”‚  â”‚  4MB   â”‚  4MB   â”‚  4MB   â”‚     â”‚  4MB              â”‚ â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â”‚       â”‚        â”‚        â”‚              â”‚                â”‚â”‚
â”‚  â”‚       â–¼        â–¼        â–¼              â–¼                â”‚â”‚
â”‚  â”‚    hash(C1) hash(C2) hash(C3)     hash(C25)            â”‚â”‚
â”‚  â”‚       â”‚                                                 â”‚â”‚
â”‚  â”‚       â–¼                                                 â”‚â”‚
â”‚  â”‚    Check in Block Storage                               â”‚â”‚
â”‚  â”‚    Exists? â†’ Don't upload (dedup)                       â”‚â”‚
â”‚  â”‚    New? â†’ Upload to S3                                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                              â”‚
â”‚  Sync Protocol:                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚  1. Client sends local file tree with hashes           â”‚â”‚
â”‚  â”‚  2. Server compares with stored state                  â”‚â”‚
â”‚  â”‚  3. Server returns diff:                               â”‚â”‚
â”‚  â”‚     â€¢ Files to download (server newer)                 â”‚â”‚
â”‚  â”‚     â€¢ Files to upload (client newer)                   â”‚â”‚
â”‚  â”‚     â€¢ Conflicts (both changed)                         â”‚â”‚
â”‚  â”‚  4. Client processes diff                              â”‚â”‚
â”‚  â”‚  5. Long polling / WebSocket for real-time updates     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                              â”‚
â”‚  Data Model:                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ files:                                                  â”‚â”‚
â”‚  â”‚   file_id, user_id, path, current_version              â”‚â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚ file_versions:                                          â”‚â”‚
â”‚  â”‚   version_id, file_id, size, created_at, chunks[]      â”‚â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚ chunks:                                                 â”‚â”‚
â”‚  â”‚   chunk_hash (PK), size, s3_location                   â”‚â”‚
â”‚  â”‚   reference_count (Ğ´Ğ»Ñ garbage collection)             â”‚â”‚
â”‚  â”‚                                                         â”‚â”‚
â”‚  â”‚ file_chunks: (many-to-many)                            â”‚â”‚
â”‚  â”‚   version_id, chunk_hash, sequence_number              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                              â”‚
â”‚  Storage Tiers:                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Hot:  S3 Standard (recent files)                        â”‚â”‚
â”‚  â”‚ Warm: S3 IA (30+ days old)                             â”‚â”‚
â”‚  â”‚ Cold: S3 Glacier (90+ days, versioning)                â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key features:**
- **Chunking:** ÑÑ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
- **Deduplication:** ÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ñ Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğ°
- **Delta sync:** Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ° Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹
- **Conflict resolution:** last-write-wins Ğ¸Ğ»Ğ¸ manual merge
